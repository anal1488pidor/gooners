name: Android CI

on:
  push:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      # 1. –ó–∞–±–∏—Ä–∞–µ–º –∫–æ–¥ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Java 17 (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è AGP 8.x)
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: gradle

      # 3. –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø—Ä–æ–µ–∫—Ç–∞ (–û–ß–ï–ù–¨ –í–ê–ñ–ù–û)
      - name: Debug project structure
        run: |
          echo "=== ROOT ==="
          pwd
          ls -la
          echo "=== FIND GRADLE FILES ==="
          find . -maxdepth 4 -name "settings.gradle*"
          find . -maxdepth 4 -name "build.gradle*"
          find . -maxdepth 4 -name "gradlew"

      # 4. –ù–∞–π—Ç–∏ gradlew –∏ –ø–µ—Ä–µ–π—Ç–∏ –≤ –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞
      - name: Locate and prepare Gradle wrapper
        run: |
          GRADLEW_PATH=$(find . -name gradlew | head -n 1)

          if [ -z "$GRADLEW_PATH" ]; then
            echo "‚ùå gradlew not found"
            exit 1
          fi

          echo "‚úÖ gradlew found at: $GRADLEW_PATH"

          PROJECT_DIR=$(dirname "$GRADLEW_PATH")
          echo "üìÅ Project dir: $PROJECT_DIR"

          cd "$PROJECT_DIR"

          chmod +x gradlew

          echo "=== PROJECT FILES ==="
          ls -la

          echo "PROJECT_DIR=$PROJECT_DIR" >> $GITHUB_ENV

      # 5. –ü–æ–∫–∞–∑–∞—Ç—å –≤–µ—Ä—Å–∏–∏ (–¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞)
      - name: Show environment info
        run: |
          java -version
          ./gradlew --version
        working-directory: ${{ env.PROJECT_DIR }}

      # 6. –°–∫–∞—á–∞—Ç—å SDK (33)
      - name: Install Android SDK components
        uses: android-actions/setup-android@v3
        with:
          packages: |
            platforms;android-33
            build-tools;33.0.1

      # 7. –û—á–∏—Å—Ç–∫–∞ (–Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π)
      - name: Clean project
        run: ./gradlew clean --no-daemon --stacktrace
        working-directory: ${{ env.PROJECT_DIR }}

      # 8. –°–ë–û–†–ö–ê –° –ü–û–õ–ù–´–ú–ò –û–®–ò–ë–ö–ê–ú–ò
      - name: Assemble Debug (FULL LOGS)
        run: |
          ./gradlew assembleDebug \
            --no-daemon \
            --stacktrace \
            --info \
            --warning-mode all
        working-directory: ${{ env.PROJECT_DIR }}

      # 9. –ó–∞–≥—Ä—É–∑–∏—Ç—å APK (–µ—Å–ª–∏ —Å–æ–±—Ä–∞–ª—Å—è)
      - name: Upload APK
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: debug-apk
          path: |
            **/build/outputs/apk/debug/*.apk
